# OTUS ДЗ 8 Загрузка системы (Centos 7)
-----------------------------------------------------------------------
### Домашнее задание

    Работа с загрузчиком
    Цель: Зайти в систему без пароля рута - базовая задача сисадмина ( ну и одно из заданий на любой линуксовой сертификации). Так же нужно уметь управлять поведением загрузчика. Это и будем учиться делать в ДЗ
    1. Попасть в систему без пароля несколькими способами
    2. Установить систему с LVM, после чего переименовать VG
    3. Добавить модуль в initrd

    4(*). Сконфигурировать систему без отдельного раздела с /boot, а только с LVM
    Репозиторий с пропатченым grub: https://yum.rumyantsev.com/centos/7/x86_64/
    PV необходимо инициализировать с параметром --bootloaderareasize 1m
    Критерии оценки: Описать действия, описать разницу между методами получения шелла в процессе загрузки.
    Где получится - используем script, где не получается - словами или копипастой описываем действия.



##1. Попасть в систему без пароля:

#Способ 1. init=/bin/sh

- Заходим в загрузчик до старта системы (перед тем, как начнется загрузка нужно успеть нажать на клашиву ```e```)
- Затем находим строку ```linux16``` и добавляем ```init=/bin/sh```, далее нажимаем ```Ctrl+X```
- Рутовая файловая система при этом монтируется в режиме Read-Only. Чтобы перемонтировать ее в режим Read-Write воспользуемся командой:
  ```mount -o remount,rw /```

#Способ 2. rd.break

- Заходим в загрузчик до старта системы (перед тем, как начнется загрузка нужно успеть нажать на клашиву ```e```)
- Затем находим строку ```linux16``` и добавляем ```rd.break```, далее нажимаем ```Ctrl+X```
- Произойдет загрузка системы в аварийном режиме, далее выполняем команду перемонтирования корня для чтения и записи - ```mount -o remount,rw /sysroot```, далее ```chroot /sysroot```
- Далее мы можем поменять пароль, выполнив команду ```passwd``` или ```passwd root```
- После смены пароля необходимо создать скрытый файл ```.autorelabel``` в /, выполнив ```touch /.autorelabel```, этот файл нужен, для того чтобы выполнить relabel файлов в системе, если selinux включен и находиться в режиме ```Enforcing```. Без этого не получится залогиниться в систему после ее загрузки. 

#Способ 3. rw init=/sysroot/bin/sh

- Заходим в загрузчик до старта системы (перед тем, как начнется загрузка нужно успеть нажать на клашиву ```e```)
- Затем находим строку ```linux16``` заменяем ```ro``` на ```rw init=/sysroot/bin/sh ```, далее нажимаем ```Ctrl+X```
- Пример аналогичен первому способу, но но файловая система сразу смонтирована в режим Read-Write


##2. Установить систему с LVM, после чего переименовать VG:

- Сначала нужно посмотреть какие Volume Group у нас есть командой ```vgs```
- Далее меняем название VG vgrename <Название которое есть сейчас> <Новое название>. Можем просмотреть новое название ```ls -l /dev/mapper```
- Теперь будем править файлы, чтобы в дальнейшем мы могли загрузиться, первый файл это ```/etc/fstab```, заходим в него и меняем старое название на новое
- Заходим в файл ```/etc/default/grub``` и в строке ```GRUB_CMDLINE_LINUX``` изменяем старое название на новое в значениях ```rd.lvm.lv```
- Заходим в файл ```/boot/grub2/grub.cfg``` и меняем старые название на новое в строке ```linux16``` нужного меню
- Далее пересоздаем initrd image, выполняем ```mkinitrd -f -v /boot/initramfs-$(uname -r).img $(uname -r)```.
- Перезагружаем компьютер, теперь у нас система загружается с новым названием VG. Также можно менять названия логических томов.

3. Добавить модуль в initrd:
- Скрипты модулей хранятся в каталоге /usr/lib/dracut/modules.d/. Для того чтобы добавить свой модуль создаем там папку с именем 01test, ```mkdir /usr/lib/dracut/modules.d/01test```
- Далее создаем там 2 скрипта - ```module-setup.sh``` и ```test.sh```, делаем их исполняемыми ```chmod +x```. В скрипт ```module-setup.sh``` вписываем:
```
#!/bin/bash

check() { # Функция, которая указывает что модуль должен быть включен по умолчанию
    return 0
}

depends() { # Выводит все зависимости от которых зависит наш модуль
    return 0
}

install() {
    inst_hook cleanup 00 "${moddir}/test.sh" # Запускает скрипт
}
```
В файле ```test.sh```:
```
#!/bin/bash

cat <<'msgend'
Hello! You are in dracut module!
 ___________________
< I'm dracut module >
 -------------------
   \
    \
        .--.
       |o_o |
       |:_/ |
      //   \ \
     (|     | )
    /'\_   _/`\
    \___)=(___/
msgend
sleep 10
echo " continuing...."
```
- Далее выполняем команду ```dracut -f -v```
- Редактируем файл ```grub.cfg```  удаляем опции rghb и quiet
- Перезагружаемся и видим пингвина
